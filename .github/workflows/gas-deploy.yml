name: GAS Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Clasp
        run: npm install -g @google/clasp

      - name: Configure Clasp auth
        env:
          CLASP_TOKEN_JSON: ${{ secrets.CLASP_TOKEN_JSON }}
        run: |
          echo "$CLASP_TOKEN_JSON" > ~/.clasprc.json
          echo "‚úî CLASP token configured."

      - name: Pull latest Apps Script project
        env:
          GAS_SCRIPT_ID: ${{ secrets.GAS_SCRIPT_ID }}
        run: |
          clasp clone $GAS_SCRIPT_ID --rootDir ./src || clasp pull

      - name: Push updates to Apps Script
        env:
          GAS_SCRIPT_ID: ${{ secrets.GAS_SCRIPT_ID }}
        run: clasp push -f

      - name: Deploy Apps Script
        run: clasp deploy -i "$GAS_SCRIPT_ID" || echo "‚úÖ Deployment finished (existing deployment reused)."

      - name: Confirm EXEC_URL
        run: |
          echo "üîç Checking for EXEC_URL in logs or manifest..."
          grep -R "https://script.google.com" . || echo "No EXEC_URL found in manifest."
