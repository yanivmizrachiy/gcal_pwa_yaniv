<!DOCTYPE html><html lang="he" dir="rtl"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>×™×•××Ÿ ×—×›× â€“ ×™× ×™×‘</title>
<link rel="manifest" href="manifest.webmanifest"><meta name="theme-color" content="#0b1220">
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Arial;background:#0b1220;color:#e7ecf5}
.wrap{max-width:900px;margin:0 auto;padding:16px}
.card{background:#101a30;border:1px solid #1e2a48;border-radius:16px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.25);margin-bottom:10px}
.top{display:flex;align-items:center;gap:10px;justify-content:space-between}
button{padding:10px 14px;border-radius:12px;border:1px solid #2e4c86;background:#1b3a6b;color:#fff;font-weight:600;cursor:pointer}
button:hover{background:#2a4d8f}
button:disabled{opacity:0.5;cursor:not-allowed}
small{color:#9fb4d9}
.btn-group{display:flex;gap:8px;flex-wrap:wrap}
input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #2e4c86;background:#0d1528;color:#e7ecf5;font-family:inherit;margin:6px 0}
textarea{min-height:80px;resize:vertical}
label{display:block;margin:8px 0 4px;font-weight:600;color:#9fb4d9}
.event-item{background:#0d1528;border:1px solid #2e4c86;border-radius:8px;padding:12px;margin:8px 0;cursor:pointer}
.event-item:hover{background:#152540}
.event-title{font-weight:600;font-size:1.1em;margin-bottom:4px}
.event-time{color:#9fb4d9;font-size:0.9em}
.message{padding:12px;border-radius:8px;margin:8px 0}
.message.success{background:#1a4d2e;border:1px solid #2d7a4f;color:#7cee9d}
.message.error{background:#4d1a1a;border:1px solid #7a2d2d;color:#ee7c7c}
.message.info{background:#1a2f4d;border:1px solid:#2d4f7a;color:#7ca6ee}
.hidden{display:none}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid #9fb4d9;border-top:2px solid #1b3a6b;border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
#nlpInput{font-size:1.1em}
.tab-buttons{display:flex;gap:4px;margin-bottom:12px}
.tab-btn{flex:1;padding:10px;border:1px solid #2e4c86;background:#0d1528;color:#e7ecf5;font-weight:600;cursor:pointer;border-radius:8px}
.tab-btn.active{background:#1b3a6b}
.tab-content{display:none}
.tab-content.active{display:block}
.color-picker{display:flex;gap:8px;flex-wrap:wrap}
.color-option{width:40px;height:40px;border-radius:8px;cursor:pointer;border:2px solid transparent}
.color-option:hover,.color-option.selected{border-color:#fff}
</style></head><body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div>×™×•××Ÿ ×—×›× â€“ ×¢×•×¨×š ××œ× ×¢× NLP ×¢×‘×¨×™×ª</div>
      <button id="installBtn">×”×ª×§×Ÿ</button>
    </div>
    <small>Android: Install / Add to Home Screen Â· iOS: Add to Home Screen</small>
  </div>

  <div class="card">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="nlp">ğŸ“ ×™×¦×™×¨×” ×‘×¢×‘×¨×™×ª</button>
      <button class="tab-btn" data-tab="events">ğŸ“… ××™×¨×•×¢×™×</button>
      <button class="tab-btn" data-tab="crud">â• CRUD</button>
    </div>

    <div id="nlp-tab" class="tab-content active">
      <label>×”×§×œ×“ ×‘××•×¤×Ÿ ×˜×‘×¢×™ ×‘×¢×‘×¨×™×ª (×“×•×’××”: "×¤×’×™×©×” ×”×™×•× 14:00â€“15:00 ×¦×‘×¢ ××“×•×")</label>
      <input type="text" id="nlpInput" placeholder='×œ×“×•×’××”: "××¨×•×—×ª ×¦×”×¨×™×™× ××—×¨ 13:00â€“14:30"'>
      <div class="btn-group">
        <button id="nlpParseBtn">ğŸ” ×¤×¢× ×—</button>
        <button id="nlpExecuteBtn">âœ… ×¦×•×¨ ××™×¨×•×¢</button>
      </div>
      <div id="nlpMessage"></div>
      <div id="nlpResult" class="hidden">
        <label>×ª×•×¦××ª ×¤×¢× ×•×—:</label>
        <pre id="nlpParsed" style="background:#0d1528;padding:10px;border-radius:8px;overflow-x:auto"></pre>
      </div>
    </div>

    <div id="events-tab" class="tab-content">
      <div class="btn-group">
        <button id="loadEventsBtn">ğŸ”„ ×˜×¢×Ÿ ××™×¨×•×¢×™×</button>
        <button id="refreshEventsBtn">â™»ï¸ ×¨×¢× ×Ÿ</button>
      </div>
      <div id="eventsMessage"></div>
      <div id="eventsList"></div>
    </div>

    <div id="crud-tab" class="tab-content">
      <label>×›×•×ª×¨×ª ××™×¨×•×¢</label>
      <input type="text" id="eventTitle" placeholder="×›×•×ª×¨×ª ×”××™×¨×•×¢">
      
      <label>×ª××¨×™×š ×•×©×¢×ª ×”×ª×—×œ×”</label>
      <input type="datetime-local" id="eventStart">
      
      <label>×ª××¨×™×š ×•×©×¢×ª ×¡×™×•×</label>
      <input type="datetime-local" id="eventEnd">
      
      <label>×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)</label>
      <textarea id="eventDescription" placeholder="×ª×™××•×¨ ×”××™×¨×•×¢"></textarea>
      
      <label>×¦×‘×¢ (××•×¤×¦×™×•× ×œ×™)</label>
      <select id="eventColor">
        <option value="">×‘×¨×™×¨×ª ××—×“×œ</option>
        <option value="1">×›×—×•×œ ×‘×”×™×¨</option>
        <option value="2">×™×¨×•×§</option>
        <option value="3">×¡×’×•×œ</option>
        <option value="4">××“×•×</option>
        <option value="5">×¦×”×•×‘</option>
        <option value="6">×›×ª×•×</option>
        <option value="7">×¦×™××Ÿ</option>
        <option value="8">××¤×•×¨</option>
        <option value="9">×›×—×•×œ</option>
        <option value="10">×™×¨×•×§ ×›×”×”</option>
        <option value="11">××“×•× ×›×”×”</option>
      </select>
      
      <div class="btn-group">
        <button id="createEventBtn">â• ×¦×•×¨ ××™×¨×•×¢</button>
        <button id="updateEventBtn" class="hidden">ğŸ’¾ ×¢×“×›×Ÿ</button>
        <button id="cancelEditBtn" class="hidden">âŒ ×‘×™×˜×•×œ</button>
      </div>
      <div id="crudMessage"></div>
      <input type="hidden" id="editEventId">
    </div>
  </div>

  <div class="card">
    <small>
      <strong>×”×•×¨××•×ª ×©×™××•×©:</strong><br>
      â€¢ <strong>×™×¦×™×¨×” ×‘×¢×‘×¨×™×ª:</strong> ×”×§×œ×“ ××©×¤×˜ ×‘×¢×‘×¨×™×ª ×¢× ×¤×¨×˜×™ ×”××™×¨×•×¢<br>
      â€¢ ×ª××™×›×” ×‘: ×”×™×•×, ××—×¨, ×™××™ ×©×‘×•×¢ (×¨××©×•×Ÿ ×”×‘×, ×©× ×™ ×”×‘×...)<br>
      â€¢ ×©×¢×•×ª ×‘×¤×•×¨××˜ HH:MMâ€“HH:MM<br>
      â€¢ ×¦×‘×¢×™×: ×¦×‘×¢ ××“×•×/×›×—×•×œ/×™×¨×•×§/×¦×”×•×‘/×›×ª×•×/×¡×’×•×œ/×•×¨×•×“<br>
      â€¢ <strong>××™×¨×•×¢×™×:</strong> ×¦×¤×” ×•×¢×¨×•×š ××™×¨×•×¢×™× ×§×™×™××™×<br>
      â€¢ <strong>CRUD:</strong> ×™×¦×™×¨×”, ×¢×¨×™×›×” ×•××—×™×§×” ×™×“× ×™×ª ×©×œ ××™×¨×•×¢×™×
    </small>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbw_AuT9V3G6IjBTAluI9PVyVA4TNjEy9DDFg5_APSHFAnAjwoMKzieowIJDmkH1DkuL/exec';

if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{});}
let dp=null; 
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dp=e;});
document.getElementById('installBtn').addEventListener('click',()=>{ 
  if(dp){dp.prompt();dp=null;} else alert('×× ××™×Ÿ Install, ×‘×—×¨ Add to Home Screen');
});

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
  });
});

// Helper functions
function showMessage(elementId, message, type) {
  const el = document.getElementById(elementId);
  el.innerHTML = `<div class="message ${type}">${message}</div>`;
  setTimeout(() => { el.innerHTML = ''; }, 5000);
}

function formatDateTime(date) {
  return new Date(date).toLocaleString('he-IL', {
    year: 'numeric', month: 'short', day: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });
}

async function callAPI(data) {
  const response = await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify(data),
    headers: {'Content-Type': 'application/json'}
  });
  return await response.json();
}

// NLP functions
document.getElementById('nlpParseBtn').addEventListener('click', async () => {
  const text = document.getElementById('nlpInput').value;
  if (!text) {
    showMessage('nlpMessage', '× × ×œ×”×–×™×Ÿ ×˜×§×¡×˜', 'error');
    return;
  }
  
  showMessage('nlpMessage', '<span class="spinner"></span> ××¤×¢× ×—...', 'info');
  
  try {
    const result = await callAPI({ action: 'text', text: text, execute: false });
    
    if (result.error) {
      showMessage('nlpMessage', result.message, 'error');
      document.getElementById('nlpResult').classList.add('hidden');
    } else {
      showMessage('nlpMessage', result.message, 'success');
      document.getElementById('nlpParsed').textContent = JSON.stringify(result.parsed, null, 2);
      document.getElementById('nlpResult').classList.remove('hidden');
    }
  } catch (err) {
    showMessage('nlpMessage', '×©×’×™××ª ×ª×§×©×•×¨×ª: ' + err.message, 'error');
  }
});

document.getElementById('nlpExecuteBtn').addEventListener('click', async () => {
  const text = document.getElementById('nlpInput').value;
  if (!text) {
    showMessage('nlpMessage', '× × ×œ×”×–×™×Ÿ ×˜×§×¡×˜', 'error');
    return;
  }
  
  showMessage('nlpMessage', '<span class="spinner"></span> ×™×•×¦×¨ ××™×¨×•×¢...', 'info');
  
  try {
    const result = await callAPI({ action: 'text', text: text, execute: true });
    
    if (result.error) {
      showMessage('nlpMessage', result.message, 'error');
    } else {
      showMessage('nlpMessage', result.message, 'success');
      document.getElementById('nlpInput').value = '';
      document.getElementById('nlpResult').classList.add('hidden');
    }
  } catch (err) {
    showMessage('nlpMessage', '×©×’×™××ª ×ª×§×©×•×¨×ª: ' + err.message, 'error');
  }
});

// Events functions
let currentEvents = [];

async function loadEvents() {
  showMessage('eventsMessage', '<span class="spinner"></span> ×˜×•×¢×Ÿ ××™×¨×•×¢×™×...', 'info');
  
  try {
    const result = await callAPI({ 
      action: 'findEvents',
      startDate: new Date().toISOString(),
      endDate: new Date(Date.now() + 30*24*60*60*1000).toISOString()
    });
    
    if (result.error) {
      showMessage('eventsMessage', result.message, 'error');
    } else {
      currentEvents = result.events;
      displayEvents(result.events);
      showMessage('eventsMessage', result.message, 'success');
    }
  } catch (err) {
    showMessage('eventsMessage', '×©×’×™××ª ×ª×§×©×•×¨×ª: ' + err.message, 'error');
  }
}

function displayEvents(events) {
  const container = document.getElementById('eventsList');
  
  if (events.length === 0) {
    container.innerHTML = '<div class="message info">××™×Ÿ ××™×¨×•×¢×™× ×œ×”×¦×’×”</div>';
    return;
  }
  
  container.innerHTML = events.map(ev => `
    <div class="event-item" data-id="${ev.id}">
      <div class="event-title">${ev.title}</div>
      <div class="event-time">${formatDateTime(ev.start)} â€“ ${formatDateTime(ev.end)}</div>
      <div class="btn-group" style="margin-top:8px">
        <button onclick="editEvent('${ev.id}')">âœï¸ ×¢×¨×•×š</button>
        <button onclick="deleteEvent('${ev.id}')">ğŸ—‘ï¸ ××—×§</button>
      </div>
    </div>
  `).join('');
}

document.getElementById('loadEventsBtn').addEventListener('click', loadEvents);
document.getElementById('refreshEventsBtn').addEventListener('click', loadEvents);

// CRUD functions
document.getElementById('createEventBtn').addEventListener('click', async () => {
  const title = document.getElementById('eventTitle').value;
  const start = document.getElementById('eventStart').value;
  const end = document.getElementById('eventEnd').value;
  const description = document.getElementById('eventDescription').value;
  const color = document.getElementById('eventColor').value;
  
  if (!title || !start || !end) {
    showMessage('crudMessage', '× × ×œ××œ× ×›×•×ª×¨×ª, ×ª××¨×™×š ×”×ª×—×œ×” ×•×¡×™×•×', 'error');
    return;
  }
  
  showMessage('crudMessage', '<span class="spinner"></span> ×™×•×¦×¨ ××™×¨×•×¢...', 'info');
  
  try {
    const result = await callAPI({
      action: 'createEvent',
      title: title,
      start: new Date(start).toISOString(),
      end: new Date(end).toISOString(),
      description: description,
      color: color || undefined
    });
    
    if (result.error) {
      showMessage('crudMessage', result.message, 'error');
    } else {
      showMessage('crudMessage', result.message, 'success');
      clearCRUDForm();
    }
  } catch (err) {
    showMessage('crudMessage', '×©×’×™××ª ×ª×§×©×•×¨×ª: ' + err.message, 'error');
  }
});

window.editEvent = async function(eventId) {
  showMessage('eventsMessage', '<span class="spinner"></span> ×˜×•×¢×Ÿ ××™×¨×•×¢...', 'info');
  
  try {
    const result = await callAPI({ action: 'getEvent', eventId: eventId });
    
    if (result.error) {
      showMessage('eventsMessage', result.message, 'error');
    } else {
      const ev = result.event;
      document.getElementById('eventTitle').value = ev.title;
      document.getElementById('eventStart').value = new Date(ev.start).toISOString().slice(0, 16);
      document.getElementById('eventEnd').value = new Date(ev.end).toISOString().slice(0, 16);
      document.getElementById('eventDescription').value = ev.description || '';
      document.getElementById('eventColor').value = ev.color || '';
      document.getElementById('editEventId').value = ev.id;
      
      document.getElementById('createEventBtn').classList.add('hidden');
      document.getElementById('updateEventBtn').classList.remove('hidden');
      document.getElementById('cancelEditBtn').classList.remove('hidden');
      
      document.querySelector('[data-tab="crud"]').click();
      showMessage('eventsMessage', '××™×¨×•×¢ × ×˜×¢×Ÿ ×œ×¢×¨×™×›×”', 'success');
    }
  } catch (err) {
    showMessage('eventsMessage', '×©×’×™××ª ×ª×§×©×•×¨×ª: ' + err.message, 'error');
  }
};

document.getElementById('updateEventBtn').addEventListener('click', async () => {
  const eventId = document.getElementById('editEventId').value;
  const title = document.getElementById('eventTitle').value;
  const start = document.getElementById('eventStart').value;
  const end = document.getElementById('eventEnd').value;
  const description = document.getElementById('eventDescription').value;
  const color = document.getElementById('eventColor').value;
  
  if (!title || !start || !end) {
    showMessage('crudMessage', '× × ×œ××œ× ×›×•×ª×¨×ª, ×ª××¨×™×š ×”×ª×—×œ×” ×•×¡×™×•×', 'error');
    return;
  }
  
  showMessage('crudMessage', '<span class="spinner"></span> ××¢×“×›×Ÿ ××™×¨×•×¢...', 'info');
  
  try {
    const result = await callAPI({
      action: 'updateEvent',
      eventId: eventId,
      title: title,
      start: new Date(start).toISOString(),
      end: new Date(end).toISOString(),
      description: description,
      color: color || undefined
    });
    
    if (result.error) {
      showMessage('crudMessage', result.message, 'error');
    } else {
      showMessage('crudMessage', result.message, 'success');
      clearCRUDForm();
      loadEvents();
    }
  } catch (err) {
    showMessage('crudMessage', '×©×’×™××ª ×ª×§×©×•×¨×ª: ' + err.message, 'error');
  }
});

window.deleteEvent = async function(eventId) {
  if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××™×¨×•×¢ ×–×”?')) return;
  
  showMessage('eventsMessage', '<span class="spinner"></span> ××•×—×§ ××™×¨×•×¢...', 'info');
  
  try {
    const result = await callAPI({ action: 'deleteEvent', eventId: eventId });
    
    if (result.error) {
      showMessage('eventsMessage', result.message, 'error');
    } else {
      showMessage('eventsMessage', result.message, 'success');
      loadEvents();
    }
  } catch (err) {
    showMessage('eventsMessage', '×©×’×™××ª ×ª×§×©×•×¨×ª: ' + err.message, 'error');
  }
};

document.getElementById('cancelEditBtn').addEventListener('click', clearCRUDForm);

function clearCRUDForm() {
  document.getElementById('eventTitle').value = '';
  document.getElementById('eventStart').value = '';
  document.getElementById('eventEnd').value = '';
  document.getElementById('eventDescription').value = '';
  document.getElementById('eventColor').value = '';
  document.getElementById('editEventId').value = '';
  
  document.getElementById('createEventBtn').classList.remove('hidden');
  document.getElementById('updateEventBtn').classList.add('hidden');
  document.getElementById('cancelEditBtn').classList.add('hidden');
}

// Auto-load events when switching to events tab
document.querySelector('[data-tab="events"]').addEventListener('click', () => {
  if (currentEvents.length === 0) {
    loadEvents();
  }
});
</script>
</body></html>
